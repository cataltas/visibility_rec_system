#!/usr/bin/env python
# -*- coding: utf-8 -*-

import sys, getopt, random
import os
from pyspark.sql import SparkSession
import pandas as pd

filepath = "hdfs:/user/ct2522/artist"

def newSparkSession():
    # return SparkSession.builder.getOrCreate()
    mem = "7GB"
    spark = (SparkSession.builder.appName("Music_Project")
             .master("yarn")
             .config("sparn.executor.memory", mem)
             .config("sparn.driver.memory", mem)
             .getOrCreate())
    spark.sparkContext.setLogLevel("ERROR")
    return spark

def prepare_gender(file_path,sparkSession=None):
    spark = sparkSession or newSparkSession()

    # This loads the JSON file and returns the gender dataframe
    artists = spark.read.json("hdfs:/user/ct2522/artist")
    artists.createOrReplaceTempView("artists")
    results=spark.sql("SELECT name,gender FROM artists")
    female=results.filter(results.gender=="Female").select(results.name,results.gender)
    male = results.filter(results.gender=="Male").select(results.name,results.gender)
    gender = female.union(male) 
    data_mb=gender.select("*").toPandas()
    df_mb = pd.DataFrame(data_mb,columns=["Name","Gender"])
    return df_mb.to_string()
# male count = 531 089, female count = 148 097, lost instances = 984 124 



def main():
    df_1=prepare_gender(filepath)
    print(df_1.head(),df_1.info())

if __name__ == "__main__":
    main()
